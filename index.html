<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Silent Disco (P2P via Simple-Peer)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <!-- Place simplepeer.min.js into ./static/simplepeer.min.js -->
  <script src="/static/simplepeer.min.js"></script>
  <style>
    body { font-family: system-ui, sans-serif; margin: 16px; }
    .row { display:flex; gap:16px; flex-wrap:wrap; }
    .card { border:1px solid #ddd; border-radius:8px; padding:12px; min-width:280px; }
    #log { white-space: pre-wrap; font-family: ui-monospace, SFMono-Regular, Menlo, monospace; font-size: 12px; background:#fafafa; border:1px solid #eee; padding:8px; max-height:260px; overflow:auto; }
    button { cursor: pointer; }
  </style>
</head>
<body>
  <h2>Silent Disco (Simple-Peer)</h2>

  <div class="row">
    <div class="card">
      <h3>Identity</h3>
      <div>Client: <span id="clientId">-</span></div>
      <div>Name: <span id="clientName">-</span></div>
      <button id="btnIdentify">Identify</button>
    </div>

    <div class="card">
      <h3>Create Room (DJ)</h3>
      <input id="roomName" placeholder="Room name" value="My Disco" />
      <button id="btnCreate">Create as DJ</button>
      <div>Room: <span id="roomId">-</span></div>
      <div>Role: <span id="role">-</span></div>
      <button id="btnPlayLocal" disabled>Play DJ Local</button>
    </div>

    <div class="card">
      <h3>Join Room (Listener)</h3>
      <input id="joinRoomId" placeholder="Room ID" />
      <button id="btnJoin">Join as Listener</button>
      <div>Role: <span id="role2">-</span></div>
      <audio id="listenerAudio" controls autoplay playsinline></audio>
    </div>
  </div>

  <h3>Log</h3>
  <div id="log"></div>

<script>
const t0 = performance.now();
const ts = () => (performance.now() - t0).toFixed(1);
const logEl = document.getElementById('log');
const log = (...a) => { console.log(...a); logEl.textContent += `[${ts()}ms] ` + a.map(x => typeof x === 'string' ? x : JSON.stringify(x)).join(' ') + '\n'; };

let ICE_CONFIG = { iceServers: [] };
let ws = null;

const state = {
  clientId: null,
  name: null,
  role: null,          // 'dj' or 'listener'
  roomId: null,
  audioStream: null,   // DJ local stream (real or dummy)
  peers: new Map(),    // peerId -> SimplePeer instance
};

async function loadIceConfig() {
  const res = await fetch('/config');
  const data = await res.json();
  ICE_CONFIG = { iceServers: data.iceServers || [] };
  log('Loaded ICE servers', ICE_CONFIG.iceServers?.length || 0);
}

async function identify() {
  const res = await fetch('/user/identify', { method: 'POST', headers: {'Content-Type':'application/json'}, body: JSON.stringify({}) });
  const data = await res.json();
  state.clientId = data.client_id;
  state.name = data.name;
  document.getElementById('clientId').textContent = state.clientId;
  document.getElementById('clientName').textContent = state.name;
  log('User identified', state.name, state.clientId);
}

async function connectWS() {
  if (!state.clientId) return;
  ws = new WebSocket(`ws://${location.host}/ws?client_id=${state.clientId}`);
  ws.onopen = () => log('WebSocket connected');
  ws.onclose = () => log('WebSocket disconnected');
  ws.onerror = (e) => log('WebSocket error', e);
  ws.onmessage = (ev) => {
    let msg = {};
    try { msg = JSON.parse(ev.data); } catch { return; }
    if (msg.type === 'new_listener') {
      // Only DJ receives this
      const listenerId = msg.listener_id;
      log('new_listener', listenerId);
      if (state.role === 'dj') {
        createPeerForListener(listenerId);
      }
      return;
    }
    if (msg.type === 'listener_left') {
      const lid = msg.listener_id;
      const p = state.peers.get(lid);
      if (p) { try { p.destroy(); } catch {} state.peers.delete(lid); }
      log('listener_left', lid);
      return;
    }
    if (msg.type === 'room_closed') {
      log('Room closed');
      return;
    }
    if (msg.type === 'sp-signal') {
      const from = msg.from;
      const payload = msg.payload;
      onSimplePeerSignal(from, payload);
      return;
    }
  };
}

function send(msg) {
  if (!ws || ws.readyState !== WebSocket.OPEN) return;
  ws.send(JSON.stringify(msg));
}

// Ensure we have an audio track before offering (dummy if needed)
async function ensureAudioTrack() {
  if (state.audioStream && state.audioStream.getAudioTracks()[0]) return;
  try {
    // Try getting a real mic track (or your DJ audio source)
    const stream = await navigator.mediaDevices.getUserMedia({ audio: true, video: false });
    state.audioStream = stream;
    log('Attached real audio track for DJ');
  } catch {
    // Fallback: silent oscillator to stabilize negotiation
    const ctx = new (window.AudioContext || window.webkitAudioContext)();
    const dst = ctx.createMediaStreamDestination();
    const osc = ctx.createOscillator(); osc.frequency.value = 0; osc.connect(dst); osc.start();
    state.audioStream = dst.stream;
    log('Attached dummy silent track for initial offer');
  }
}

function createPeerForListener(listenerId) {
  // DJ -> create initiator peer
  const p = new SimplePeer({
    initiator: true,
    trickle: true,
    stream: state.audioStream || undefined,
    config: ICE_CONFIG
  });

  wirePeerEvents(p, listenerId, 'dj');
  state.peers.set(listenerId, p);
}

function ensurePeerForDj(djId) {
  // Listener -> ensure responder peer
  if (state.peers.has(djId)) return state.peers.get(djId);
  const p = new SimplePeer({
    initiator: false,
    trickle: true,
    config: ICE_CONFIG
  });
  wirePeerEvents(p, djId, 'listener');
  state.peers.set(djId, p);
  return p;
}

function wirePeerEvents(p, peerId, role) {
  p.on('signal', (payload) => {
    // Send any SDP/ICE from Simple-Peer
    send({ type: 'sp-signal', target: peerId, from: state.clientId, payload });
    log(role === 'dj' ? 'DJ sp-signal →' : 'Listener sp-signal →', peerId, typeof payload === 'string' ? payload.slice(0, 40) + '...' : Object.keys(payload));
  });
  p.on('connect', () => {
    log('peer connected', peerId);
  });
  p.on('stream', (remoteStream) => {
    if (role === 'listener') {
      const el = document.getElementById('listenerAudio');
      el.srcObject = remoteStream;
      el.play().then(() => log('listener audio playing')).catch(e => log('listener play error', e));
    }
  });
  p.on('error', (err) => {
    log('peer error', peerId, err?.message || err);
  });
  p.on('close', () => {
    log('peer closed', peerId);
  });
}

function onSimplePeerSignal(fromPeerId, payload) {
  // If listener, fromPeerId is the DJ; if DJ, fromPeerId is a listener
  const p = state.peers.get(fromPeerId) || (state.role === 'listener' ? ensurePeerForDj(fromPeerId) : null);
  if (!p) {
    log('signal for missing peer', fromPeerId);
    return;
  }
  try {
    p.signal(payload);
    log('sp-signal applied from', fromPeerId, typeof payload === 'string' ? payload.slice(0, 40) + '...' : Object.keys(payload));
  } catch (e) {
    log('signal apply error', fromPeerId, e?.message || e);
  }
}

// UI actions
document.getElementById('btnIdentify').onclick = async () => { await identify(); await loadIceConfig(); await connectWS(); };

document.getElementById('btnCreate').onclick = async () => {
  if (!state.clientId) { await identify(); await loadIceConfig(); await connectWS(); }
  const name = (document.getElementById('roomName').value || 'My Disco').trim();
  const res = await fetch('/room/create', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ client_id: state.clientId, name }) });
  const data = await res.json();
  if (!data.ok) { log('create failed', data.error || ''); return; }
  state.roomId = data.room_id;
  state.role = 'dj';
  document.getElementById('roomId').textContent = state.roomId;
  document.getElementById('role').textContent = 'dj';
  document.getElementById('btnPlayLocal').disabled = false;
  // Join as DJ
  await fetch(`/room/${state.roomId}/join`, { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ client_id: state.clientId, role: 'dj' }) });
  // Ensure audio ready for first initiations
  await ensureAudioTrack();
  log('DJ ready; will create peers on new_listener');
};

document.getElementById('btnPlayLocal').onclick = async () => {
  // Local monitoring for DJ
  if (!state.audioStream) { await ensureAudioTrack(); }
  const localAudio = new Audio();
  localAudio.srcObject = state.audioStream;
  localAudio.muted = false;
  localAudio.autoplay = true;
  localAudio.playsInline = true;
  localAudio.play().then(() => log('Playing (local)')).catch(e => log('Local play error', e));
};

document.getElementById('btnJoin').onclick = async () => {
  if (!state.clientId) { await identify(); await loadIceConfig(); await connectWS(); }
  const rid = (document.getElementById('joinRoomId').value || '').trim();
  if (!rid) { log('enter room id'); return; }
  state.roomId = rid;
  state.role = 'listener';
  document.getElementById('role2').textContent = 'listener';
  const res = await fetch(`/room/${state.roomId}/join`, { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ client_id: state.clientId, role: 'listener' }) });
  const data = await res.json();
  if (!data.ok) { log('join failed', data.error || ''); return; }
  log('Joined room as listener; wait for DJ signaling');
};

// Auto-identify on load for convenience
window.addEventListener('load', async () => {
  await identify();
  await loadIceConfig();
  await connectWS();
});
</script>
</body>
</html>
